# ============================================
# LAMMPS Container Definition File
# Author: Ethan L. Edmunds
# Version: v2.0
# Description: LAMMPS CPU MPI container with Python support and OpenMPI+PMIx
# Base: ubuntu:24.04
# ============================================

Bootstrap: docker
From: ubuntu:24.04

%labels
    Author Ethan L. Edmunds
    Version v2.0
    Description LAMMPS CPU MPI container with OpenMPI+PMIx

%post
    # ---------------------------
    # Noninteractive frontend
    # ---------------------------
    export DEBIAN_FRONTEND=noninteractive

    # ---------------------------
    # Install build dependencies
    # ---------------------------
    apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        g++ \
        cmake \
        git \
        gfortran \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        wget \
        curl \
        openmpi-bin \
        libopenmpi-dev \
        automake \
        libtool \
        pkg-config \
        m4 \
        qt6-base-dev \
        liblapack-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

    # ---------------------------
    # Install Atomsk
    # ---------------------------
    git clone https://github.com/pierrehirel/atomsk.git /opt/atomsk/
    cd /opt/atomsk/src
    make -j3 atomsk
    cd ..
    cp src/atomsk .
    chmod +x /opt/atomsk/atomsk

    # ---------------------------
    # Create Python virtual environment
    # ---------------------------
    python3 -m venv /opt/venv
    export PATH="/opt/venv/bin:$PATH"
    /opt/venv/bin/pip install --upgrade pip
    /opt/venv/bin/pip install numpy scipy pandas ase matscipy atomman cython mpi4py ovito

    # ---------------------------
    # Clone and checkout LAMMPS stable release
    # ---------------------------
    git clone --depth 1 --branch release https://github.com/lammps/lammps.git /opt/lammps
    git config --system --add safe.directory /opt/lammps
    cd /opt/lammps
    git fetch --tags
    git checkout tags/stable_22Jul2025

    # ---------------------------
    # Build LAMMPS with MPI support
    # ---------------------------
    mkdir build && cd build
    cmake ../cmake \
        -D CMAKE_BUILD_TYPE=Release \
        -D CMAKE_C_COMPILER=/usr/bin/gcc \
        -D CMAKE_CXX_COMPILER=/usr/bin/mpicxx.openmpi \
        -D BUILD_MPI=ON \
        -D BUILD_SHARED_LIBS=ON \
        -D BUILD_OMP=ON \
        -D PKG_REPLICA=ON \
        -D PKG_MANYBODY=ON \
        -D PKG_PYTHON=ON \
        -D PYTHON_EXECUTABLE=/opt/venv/bin/python3

    cmake --build . -j $(nproc)
    cmake --install .

    # ---------------------------
    # Install Python bindings
    # ---------------------------
    cd /opt/lammps/python
    /opt/venv/bin/pip install .

%environment
    # ---------------------------
    # Add Python and LAMMPS to PATH
    # ---------------------------
    export PATH="/opt/venv/bin:/opt/lammps/build:$PATH"
    export LD_LIBRARY_PATH=/opt/lammps/build:$MPI_HOME/lib:$LD_LIBRARY_PATH

%runscript
      
    # Execute the requested command
    exec "$@"
